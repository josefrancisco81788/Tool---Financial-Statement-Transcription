{
  "timestamp": "20250903_141708",
  "app_analysis": {
    "total_functions": 36,
    "key_functions": {
      "main_processing": [
        "analyze_document_characteristics",
        "log_processing",
        "analyze_page_content_semantically",
        "process_pdf_with_vector_db",
        "process_pdf_with_whole_document_context",
        "handle_processing_error",
        "validate_file_upload",
        "main"
      ],
      "phase1_related": [],
      "financial_extraction": [
        "analyze_document_characteristics",
        "init_database",
        "convert_pdf_to_images",
        "extract_text_for_page",
        "extract_text_with_vision_api",
        "extract_financial_data",
        "log_processing",
        "display_extracted_data",
        "get_corrected_year_data",
        "display_single_page_data",
        "classify_financial_statement_pages",
        "classify_single_page",
        "calculate_number_density_score",
        "extract_comprehensive_financial_data",
        "init_chromadb",
        "create_or_get_collection",
        "analyze_page_content_semantically",
        "process_pdf_with_vector_db",
        "get_confidence_score",
        "extract_financial_data_for_page",
        "create_ifrs_csv_export",
        "add_section_rows",
        "consolidate_financial_data",
        "merge_equity_into_balance_sheet",
        "process_pdf_with_whole_document_context",
        "transform_to_analysis_ready_format",
        "handle_processing_error",
        "main",
        "update_progress"
      ],
      "gpt_processing": [
        "analyze_document_characteristics",
        "encode_image",
        "extract_text_with_vision_api",
        "encode_pil_image",
        "extract_financial_data",
        "extract_comprehensive_financial_data",
        "consolidate_financial_data",
        "process_pdf_with_whole_document_context",
        "show_user_friendly_error",
        "main",
        "update_progress"
      ]
    },
    "function_details": {
      "exponential_backoff_retry": {
        "calls": [
          "sleep",
          "error",
          "warning",
          "func",
          "Exception",
          "range",
          "uniform",
          "lower",
          "str",
          "min"
        ],
        "length": 1306,
        "has_phase1_ref": false,
        "has_financial_extraction": false,
        "has_gpt_call": false
      },
      "analyze_document_characteristics": {
        "calls": [
          "gradient",
          "getenv",
          "warning",
          "len",
          "document",
          "rgba",
          "except",
          "OpenAI",
          "Exception",
          "markdown",
          "getvalue",
          "Document",
          "convert_from_bytes",
          "pdf2image",
          "close",
          "load_dotenv",
          "str",
          "set_page_config"
        ],
        "length": 4538,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": true
      },
      "init_database": {
        "calls": [
          "connect",
          "warning",
          "execute",
          "deployments",
          "commit",
          "processing_log",
          "close",
          "cursor",
          "str"
        ],
        "length": 919,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "encode_image": {
        "calls": [
          "b64encode",
          "getvalue",
          "decode"
        ],
        "length": 145,
        "has_phase1_ref": false,
        "has_financial_extraction": false,
        "has_gpt_call": true
      },
      "convert_pdf_to_images": {
        "calls": [
          "empty",
          "error",
          "extract_text_for_page",
          "convert_from_bytes",
          "pdf2image",
          "BytesIO",
          "ThreadPoolExecutor",
          "result",
          "Matrix",
          "success",
          "enumerate",
          "open",
          "info",
          "tobytes",
          "warning",
          "as_completed",
          "append",
          "get_pixmap",
          "visibility",
          "range",
          "load_page",
          "Document",
          "submit",
          "close",
          "DPI",
          "lower",
          "str",
          "len",
          "text",
          "progress",
          "keys",
          "markdown",
          "getvalue",
          "page",
          "sorted",
          "extract_text_with_vision_api",
          "expander"
        ],
        "length": 6076,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "extract_text_for_page": {
        "calls": [
          "empty",
          "error",
          "ThreadPoolExecutor",
          "result",
          "success",
          "enumerate",
          "info",
          "warning",
          "as_completed",
          "append",
          "submit",
          "lower",
          "str",
          "len",
          "text",
          "progress",
          "keys",
          "sorted",
          "extract_text_with_vision_api"
        ],
        "length": 3735,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "extract_text_with_vision_api": {
        "calls": [
          "create",
          "names",
          "encode_pil_image",
          "Exception",
          "exponential_backoff_retry",
          "str"
        ],
        "length": 1809,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": true
      },
      "encode_pil_image": {
        "calls": [
          "seek",
          "decode",
          "b64encode",
          "BytesIO",
          "getvalue",
          "save"
        ],
        "length": 234,
        "has_phase1_ref": false,
        "has_financial_extraction": false,
        "has_gpt_call": true
      },
      "extract_financial_data": {
        "calls": [
          "error",
          "encode_image",
          "create",
          "info",
          "exponential_backoff_retry",
          "process_pdf_with_vector_db",
          "str"
        ],
        "length": 2309,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": true
      },
      "log_processing": {
        "calls": [
          "connect",
          "execute",
          "fails",
          "commit",
          "now",
          "processing_log",
          "VALUES",
          "close",
          "cursor"
        ],
        "length": 627,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "get_confidence_class": {
        "calls": [],
        "length": 320,
        "has_phase1_ref": false,
        "has_financial_extraction": false,
        "has_gpt_call": false
      },
      "ensure_confidence_score": {
        "calls": [
          "isinstance",
          "replace",
          "except",
          "max",
          "float",
          "min"
        ],
        "length": 648,
        "has_phase1_ref": false,
        "has_financial_extraction": false,
        "has_gpt_call": false
      },
      "display_extracted_data": {
        "calls": [
          "isinstance",
          "append",
          "download_button",
          "subheader",
          "get",
          "concat",
          "enumerate",
          "markdown",
          "strftime",
          "now",
          "display_single_page_data",
          "zip",
          "tabs",
          "to_csv"
        ],
        "length": 1545,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "get_corrected_year_data": {
        "calls": [
          "isinstance",
          "int",
          "float",
          "get",
          "keys",
          "enumerate",
          "years",
          "sorted",
          "isdigit",
          "str"
        ],
        "length": 1520,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "display_single_page_data": {
        "calls": [
          "title",
          "int",
          "values",
          "sum",
          "transform_to_analysis_ready_format",
          "isinstance",
          "join",
          "subheader",
          "get",
          "head",
          "DataFrame",
          "enumerate",
          "ensure_confidence_score",
          "info",
          "abs",
          "items",
          "min",
          "warning",
          "metric",
          "replace",
          "subcategory",
          "append",
          "download_button",
          "dataframe",
          "caption",
          "format",
          "get_confidence_class",
          "any",
          "float",
          "hash",
          "id",
          "str",
          "len",
          "Metrics",
          "number_input",
          "field",
          "CSV",
          "write",
          "markdown",
          "strftime",
          "now",
          "structure",
          "amount",
          "expander",
          "columns",
          "to_csv"
        ],
        "length": 16871,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "classify_financial_statement_pages": {
        "calls": [
          "empty",
          "error",
          "values",
          "ThreadPoolExecutor",
          "result",
          "sum",
          "success",
          "join",
          "subheader",
          "get",
          "max",
          "enumerate",
          "DataFrame",
          "info",
          "higher",
          "items",
          "classify_single_page",
          "as_completed",
          "append",
          "calculate_number_density_score",
          "statement",
          "dataframe",
          "indicators",
          "findall",
          "submit",
          "lower",
          "str",
          "len",
          "text",
          "extend",
          "write",
          "progress",
          "keys",
          "sorted",
          "score",
          "expander",
          "patterns"
        ],
        "length": 18716,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "classify_single_page": {
        "calls": [
          "empty",
          "error",
          "values",
          "ThreadPoolExecutor",
          "result",
          "sum",
          "success",
          "join",
          "subheader",
          "get",
          "max",
          "enumerate",
          "DataFrame",
          "info",
          "higher",
          "items",
          "as_completed",
          "append",
          "calculate_number_density_score",
          "statement",
          "dataframe",
          "indicators",
          "findall",
          "submit",
          "lower",
          "str",
          "len",
          "text",
          "extend",
          "write",
          "progress",
          "keys",
          "sorted",
          "score",
          "expander",
          "patterns"
        ],
        "length": 15380,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "calculate_number_density_score": {
        "calls": [
          "len",
          "append",
          "extend",
          "numbers",
          "negative",
          "add",
          "findall",
          "split",
          "set"
        ],
        "length": 2583,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "extract_comprehensive_financial_data": {
        "calls": [
          "correct_year_propagation_issues",
          "numbers",
          "VALUES",
          "loads",
          "exponential_backoff_retry",
          "isinstance",
          "rfind",
          "get",
          "name",
          "STRUCTURE",
          "find",
          "level",
          "items",
          "create",
          "print",
          "Exception",
          "year",
          "str",
          "len",
          "missing",
          "validate_correction_results",
          "years"
        ],
        "length": 8218,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": true
      },
      "init_chromadb": {
        "calls": [
          "getenv",
          "SentenceTransformer",
          "warning",
          "PersistentClient",
          "success",
          "embeddings",
          "error",
          "SentenceTransformerEmbeddingFunction",
          "Settings",
          "info",
          "lower"
        ],
        "length": 1968,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "create_or_get_collection": {
        "calls": [
          "create_collection",
          "get_collection"
        ],
        "length": 494,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "analyze_page_content_semantically": {
        "calls": [
          "error",
          "int",
          "type",
          "content",
          "variations",
          "max",
          "else",
          "min",
          "warning",
          "query",
          "append",
          "replace",
          "time",
          "any",
          "findall",
          "ANALYSIS",
          "zip",
          "lower",
          "len",
          "strip",
          "write",
          "count",
          "add",
          "score"
        ],
        "length": 9190,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "process_pdf_with_vector_db": {
        "calls": [
          "empty",
          "error",
          "type",
          "content",
          "ThreadPoolExecutor",
          "result",
          "extract_financial_data_for_page",
          "isinstance",
          "success",
          "extract_comprehensive_financial_data",
          "classify_financial_statement_pages",
          "get",
          "DataFrame",
          "enumerate",
          "encode_pil_image",
          "ensure_confidence_score",
          "info",
          "min",
          "warning",
          "get_confidence_score",
          "as_completed",
          "convert_pdf_to_images",
          "append",
          "consolidate_financial_data",
          "dataframe",
          "submit",
          "float",
          "lower",
          "str",
          "minutes",
          "len",
          "text",
          "progress",
          "keys",
          "sort",
          "sorted",
          "processing",
          "expander"
        ],
        "length": 12342,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "get_confidence_score": {
        "calls": [
          "empty",
          "error",
          "type",
          "content",
          "ThreadPoolExecutor",
          "result",
          "extract_financial_data_for_page",
          "isinstance",
          "success",
          "extract_comprehensive_financial_data",
          "get",
          "DataFrame",
          "enumerate",
          "encode_pil_image",
          "ensure_confidence_score",
          "info",
          "min",
          "warning",
          "as_completed",
          "append",
          "consolidate_financial_data",
          "dataframe",
          "submit",
          "float",
          "lower",
          "str",
          "minutes",
          "len",
          "text",
          "progress",
          "keys",
          "sort",
          "sorted",
          "processing",
          "expander"
        ],
        "length": 10979,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "extract_financial_data_for_page": {
        "calls": [
          "empty",
          "error",
          "type",
          "content",
          "ThreadPoolExecutor",
          "result",
          "success",
          "extract_comprehensive_financial_data",
          "get",
          "encode_pil_image",
          "enumerate",
          "ensure_confidence_score",
          "info",
          "warning",
          "as_completed",
          "append",
          "consolidate_financial_data",
          "submit",
          "lower",
          "str",
          "len",
          "text",
          "progress",
          "keys",
          "sorted"
        ],
        "length": 8210,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "create_ifrs_csv_export": {
        "calls": [
          "isinstance",
          "title",
          "first",
          "replace",
          "append",
          "get",
          "DataFrame",
          "add_section_rows",
          "items",
          "to_csv"
        ],
        "length": 2171,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "add_section_rows": {
        "calls": [
          "isinstance",
          "title",
          "first",
          "replace",
          "append",
          "get",
          "DataFrame",
          "items",
          "to_csv"
        ],
        "length": 2008,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "consolidate_financial_data": {
        "calls": [
          "error",
          "title",
          "headers",
          "Completeness",
          "ValueError",
          "scores",
          "search",
          "loads",
          "exponential_backoff_retry",
          "accuracy",
          "success",
          "isinstance",
          "get",
          "dumps",
          "display",
          "group",
          "info",
          "find",
          "items",
          "getenv",
          "warning",
          "create",
          "metric",
          "replace",
          "str",
          "len",
          "OpenAI",
          "strip",
          "write",
          "startswith",
          "expander",
          "columns"
        ],
        "length": 17876,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": true
      },
      "merge_equity_into_balance_sheet": {
        "calls": [
          "isinstance",
          "if",
          "field",
          "get",
          "copy",
          "any",
          "items"
        ],
        "length": 3221,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "process_pdf_with_whole_document_context": {
        "calls": [
          "error",
          "headers",
          "balances",
          "correct_year_propagation_issues",
          "ValueError",
          "search",
          "loads",
          "exponential_backoff_retry",
          "statements",
          "success",
          "get",
          "enumerate",
          "group",
          "info",
          "find",
          "warning",
          "create",
          "replace",
          "convert_pdf_to_images",
          "append",
          "print",
          "metric",
          "str",
          "len",
          "strip",
          "write",
          "validate_correction_results",
          "startswith",
          "expander",
          "columns"
        ],
        "length": 18838,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": true
      },
      "transform_to_analysis_ready_format": {
        "calls": [
          "int",
          "except",
          "update",
          "set",
          "fillna",
          "isinstance",
          "get",
          "DataFrame",
          "enumerate",
          "to_numeric",
          "append",
          "range",
          "float",
          "str",
          "len",
          "mapping",
          "keys",
          "years",
          "sorted",
          "isdigit",
          "columns"
        ],
        "length": 4632,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "show_user_friendly_error": {
        "calls": [
          "error",
          "and",
          "format",
          "info",
          "lower",
          "str"
        ],
        "length": 2157,
        "has_phase1_ref": false,
        "has_financial_extraction": false,
        "has_gpt_call": true
      },
      "handle_processing_error": {
        "calls": [
          "show_user_friendly_error",
          "error",
          "log_processing",
          "str"
        ],
        "length": 672,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": false
      },
      "validate_file_upload": {
        "calls": [
          "size",
          "large"
        ],
        "length": 569,
        "has_phase1_ref": false,
        "has_financial_extraction": false,
        "has_gpt_call": false
      },
      "main": {
        "calls": [
          "error",
          "Sheet",
          "AVG",
          "process_pdf_with_whole_document_context",
          "connect",
          "container",
          "documents",
          "Equity",
          "selected",
          "gracefully",
          "process_pdf_with_vector_db",
          "items",
          "statement",
          "display_extracted_data",
          "str",
          "fetchone",
          "rerun",
          "startswith",
          "columns",
          "list",
          "checkbox",
          "sum",
          "success",
          "isinstance",
          "subheader",
          "get",
          "enumerate",
          "extract_financial_data",
          "Poppler",
          "metric",
          "caption",
          "handle_processing_error",
          "upper",
          "size",
          "readable",
          "len",
          "text",
          "progress",
          "keys",
          "update_progress",
          "title",
          "type",
          "init_chromadb",
          "values",
          "spinner",
          "open",
          "info",
          "changes",
          "approach",
          "validate_file_upload",
          "warning",
          "log_processing",
          "download_button",
          "any",
          "stop",
          "lower",
          "image",
          "header",
          "markdown",
          "analyze_document_characteristics",
          "split",
          "cursor",
          "merge_equity_into_balance_sheet",
          "empty",
          "copy",
          "unavailable",
          "button",
          "execute",
          "getenv",
          "replace",
          "append",
          "file_uploader",
          "concat",
          "COUNT",
          "close",
          "write",
          "init_database",
          "strftime",
          "now",
          "total_seconds",
          "processing",
          "expander",
          "to_csv"
        ],
        "length": 33033,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": true
      },
      "update_progress": {
        "calls": [
          "error",
          "title",
          "values",
          "sum",
          "process_pdf_with_whole_document_context",
          "isinstance",
          "success",
          "button",
          "spinner",
          "subheader",
          "get",
          "main",
          "info",
          "process_pdf_with_vector_db",
          "extract_financial_data",
          "warning",
          "replace",
          "append",
          "log_processing",
          "handle_processing_error",
          "str",
          "len",
          "text",
          "progress",
          "markdown",
          "rerun",
          "now",
          "total_seconds",
          "columns"
        ],
        "length": 7161,
        "has_phase1_ref": false,
        "has_financial_extraction": true,
        "has_gpt_call": true
      }
    }
  },
  "phase1_usage": {},
  "processing_paths": {
    "streamlit_app": {
      "entry_points": [
        "analyze_document_characteristics",
        "log_processing",
        "analyze_page_content_semantically",
        "process_pdf_with_vector_db",
        "process_pdf_with_whole_document_context",
        "handle_processing_error",
        "validate_file_upload",
        "main"
      ],
      "description": "Streamlit web interface"
    },
    "api_endpoints": {
      "entry_points": [
        "api/services/file_processor.py:process"
      ],
      "description": "FastAPI REST endpoints"
    },
    "direct_processing": {
      "entry_points": [
        "field_discovery.py:main",
        "data_population.py:main",
        "raw_data_extraction.py:main"
      ],
      "description": "Direct processing functions"
    }
  },
  "data_flow": {
    "years_detected_usage": [
      "app.py: def get_corrected_year_data(item_info, main_value, years_detected, base_year):",
      "app.py: for i, year in enumerate(years_detected[1:], 1):",
      "field_discovery.py: years_detected: List[str],",
      "field_discovery.py: years_detected: Years detected in Phase 1",
      "data_population.py: years_detected: List[str],",
      "data_population.py: years_detected: Years detected in Phase 1",
      "raw_data_extraction.py: years_detected: List[str]",
      "raw_data_extraction.py: years_detected: Years detected in Phase 1",
      "year_consolidation.py: years_detected: List[str]",
      "year_consolidation.py: years_detected: Years detected in Phase 1",
      "template_mapping.py: years_detected: List[str]",
      "template_mapping.py: years_detected: Years detected in Phase 1",
      "api/services/file_processor.py: years_detected = data.get(\"years_detected\", [])",
      "api/services/file_processor.py: if not years_detected:"
    ],
    "full_document_text_usage": [
      "app.py: full_document_text = \"\"",
      "app.py: full_document_text += f\"\\n\\n=== PAGE {page_num} ===\\n{page_text}\""
    ],
    "page_info_usage": [],
    "direct_phase1_calls": []
  },
  "failure_points": [
    "app.py: Only processes year_1 and year_2 (6 occurrences)",
    "raw_data_extraction.py: Low token limits that might truncate (1 occurrences)",
    "year_consolidation.py: Low token limits that might truncate (2 occurrences)",
    "template_mapping.py: Only processes year_1 and year_2 (4 occurrences)"
  ]
}